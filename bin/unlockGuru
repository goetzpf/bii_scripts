#!/bin/sh
#

#  This software is copyrighted by the BERLINER SPEICHERRING
#  GESELLSCHAFT FUER SYNCHROTRONSTRAHLUNG M.B.H., BERLIN, GERMANY.
#  The following terms apply to all files associated with the software.
#  
#  BESSY hereby grants permission to use, copy and modify this
#  software and its documentation for non-commercial, educational or
#  research purposes provided that existing copyright notices are
#  retained in all copies.
#  
#  The receiver of the software provides BESSY with all enhancements, 
#  including complete translations, made by the receiver.
#  
#  IN NO EVENT SHALL BESSY BE LIABLE TO ANY PARTY FOR DIRECT, INDIRECT,
#  SPECIAL, INCIDENTIAL OR CONSEQUENTIAL DAMAGES ARISING OUT OF THE USE
#  OF THIS SOFTWARE, ITS DOCUMENTATION OR ANY DERIVATIVES THEREOF, EVEN 
#  IF BESSY HAS BEEN ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
#  
#  BESSY SPECIFICALLY DISCLAIMS ANY WARRANTIES, INCLUDING, BUT NOT LIMITED
#  TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR
#  PURPOSE, AND NON-INFRINGEMENT. THIS SOFTWARE IS PROVIDED ON AN "AS IS"
#  BASIS, AND BESSY HAS NO OBLIGATION TO PROVIDE MAINTENANCE, SUPPORT,
#  UPDATES, ENHANCEMENTS OF MODIFICATIONS.


# Remove the mutex file lock
#
# Own lock ID has to be set in the environment var GURU_LOCK

if [ "${DEBUG:+1}" = "1" ]; then
    echo unlockGuru script: DEBUG MODE
    echo My own lock ID is $GURU_LOCK
fi

# If there is a lock

if [ -h ~/.guruLock ]; then

# Get the lock info
    lock_line=$(/bin/ls -al | grep "\.guruLock")
    lock_target=${lock_line##* }
    lock_id=${lock_target%%-*}
    lock_owner=${lock_target##*-}
    lock_12=${lock_line%% .guruLock*}
    lock_1=${lock_12%% [A-Z]*}
    lock_time=${lock_12#$lock_1 }

    if [ "${DEBUG:+1}" = "1" ]; then
	echo Found a lock by $lock_owner \(ID $lock_id\) created $lock_time
    fi

# Check if it is mine

    if [ "X$lock_id" = "X$GURU_LOCK" ]; then

	if [ "${DEBUG:+1}" = "1" ]; then
	    echo This lock is mine - deleting it
	fi
	rm -f ~/.guruLock
    else
	if [ "${DEBUG:+1}" = "1" ]; then
	    echo This is a foreign lock - not touching it
	fi
    fi

else

# No lock there

    if [ "${DEBUG:+1}" = "1" ]; then
	echo No lock present
    fi

fi
