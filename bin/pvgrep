#!/usr/bin/zsh -f
# -*- shell-script -*-

# Copyright 2015 Helmholtz-Zentrum Berlin f√ºr Materialien und Energie GmbH
# <https://www.helmholtz-berlin.de>
#
# Author: Thomas Birke <Thomas.Birke@helmholtz-berlin.de>
#
# This program is free software: you can redistribute it and/or modify it under
# the terms of the GNU General Public License as published by the Free Software
# Foundation, either version 3 of the License, or (at your option) any later
# version.
# 
# This program is distributed in the hope that it will be useful, but WITHOUT
# ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
# FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more
# details.
# 
# You should have received a copy of the GNU General Public License along with
# this program.  If not, see <http://www.gnu.org/licenses/>.

usage () {
    <<EOF
usage: pvgrep [-io] [-flat] [-ext <ext>] <regexp>

grep for lines matching <regexp> in files produced by IOCs

Options:
  -flat       suppress IOC name, just print output unindented
  -ext <ext>  search files with extension <ext> instead
              default is dbl, -io sets ext to dbhcr
              possible extensions are: 
               activated, dbhcr, dbior, dbl, pwd, version and versions
  -io         search dbhcr-files (short for -ext dbhcr)
  -ioc <GLOB> search only IOCS matching GLOB pattern (default: *)
EOF
    return
}
[[ $# -eq 0 ]] && usage

zparseopts -D io=oio flat=oflat ext:=oext ioc:=iocglob

flat=0
spc="  "
ext=dbl
[[ "$oio" = "-io" ]] && ext=dbhcr
[[ "$oflat" = "-flat" ]] && flat=1 spc=""
[[ $#oext -gt 1 ]] && ext=$oext[2]
[[ $#iocglob -gt 1 ]] && iocglob=$iocglob[2] || iocglob="*"

setopt nullglob

cd /opt/IOC/log/Database
/bin/egrep --color=auto $1 */*.$ext */*_$ext.txt | perl -e "
while (<>) { 
    (\$ioc,\$rest,\$var)=split qq([._]$ext([^:]*):); 
    \$iocs->{\$ioc}->{\$var}=1;
}; 
for \$ioc (sort keys %\$iocs) {
    print \"\$ioc:\\n\" unless $flat; 
    for \$var (sort keys %{\$iocs->{\$ioc}}) { print(\"$spc\$var\"); }
}"
