#!/bin/sh

# Copyright 2015 Helmholtz-Zentrum Berlin f√ºr Materialien und Energie GmbH
# <https://www.helmholtz-berlin.de>
#
# Author: Benjamin Franksen <Benjamin.Franksen@helmholtz-berlin.de>
#
# This program is free software: you can redistribute it and/or modify it under
# the terms of the GNU General Public License as published by the Free Software
# Foundation, either version 3 of the License, or (at your option) any later
# version.
# 
# This program is distributed in the hope that it will be useful, but WITHOUT
# ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
# FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more
# details.
# 
# You should have received a copy of the GNU General Public License along with
# this program.  If not, see <http://www.gnu.org/licenses/>.

[ "$DARCS_SAVE" = "NO" ] && exit

dest=.darcs-restore

cleanup () {
  #unrecord the tag
  yes | darcs unrecord -a --last=1
  #unrecord not-added files
  yes | darcs unrecord -p'^NOT-ADDED$' -a --last=1
  #un-add these files
  darcs whatsnew -s | grep -v 'No changes!' | sed 's/^A //' | xargs darcs remove
  #unrecord not recorded changes
  yes | darcs unrecord -p'^NOT-RECORDED$' -a --last=1
  exit
}
trap cleanup INT QUIT TERM
test -d $dest || mkdir $dest
if test -n "$1"; then
  echo "$1" > "$dest/defaultrepo"
elif test ! -e _darcs/prefs/defaultrepo; then
  cp _darcs/prefs/defaultrepo $dest
else
  echo "no master repo specified and no defaultrepo found - skipping darcs-save" >&2
  exit
fi
darcs record -a --skip-long-comment -m NOT-RECORDED
darcs record -a --skip-long-comment -l -m NOT-ADDED
darcs tag "`whoami`@`uname -n`:`pwd`"
darcs send -a --output=$dest/local-patches --dont-edit-description
darcs changes -a --context --repo=`cat _darcs/prefs/defaultrepo` > $dest/remote-context
darcs changes --context > $dest/local-context
cleanup
