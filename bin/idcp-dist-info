#!/bin/bash

# Copyright 2015 Helmholtz-Zentrum Berlin f√ºr Materialien und Energie GmbH
# <https://www.helmholtz-berlin.de>
#
# Author: Goetz Pfeiffer <Goetz.Pfeiffer@helmholtz-berlin.de>
#
# This program is free software: you can redistribute it and/or modify it under
# the terms of the GNU General Public License as published by the Free Software
# Foundation, either version 3 of the License, or (at your option) any later
# version.
# 
# This program is distributed in the hope that it will be useful, but WITHOUT
# ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
# FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more
# details.
# 
# You should have received a copy of the GNU General Public License along with
# this program.  If not, see <http://www.gnu.org/licenses/>.

CONFIGFILE_PATH=/opt/OPI/idcp/rsync-dist.config.BII

CONFIGFILE_BII=$CONFIGFILE_PATH/idcp
CONFIGFILE_MLS=$CONFIGFILE_PATH/idcp-mls

CONFIGFILE=$CONFIGFILE_BII

installed_ids_bii="^idcp(3|5|6|7|8|9|10|11|12|13|15|110)$"
installed_ids_mls="^idcp(90)$"

installed_ids=$installed_ids_bii

function print_short_help {
    echo "$0: a small wrapper that calls rsync-dist-info.py"
    echo "options:"
    echo "  -h: this help"
    echo "  -H: this text PLUS the help from rsync-dist-info.py"
    echo "  --id [ID] : filter for this insertion device"
    echo "  --ids : filter for all ID's that are installed and use"
    echo "      the rsync-dist.pl (Ue56/2 is not in this list)"
    echo "  --id-list : show the known insertion devices and their idcp-name"
    echo "  --facility [FACILITY]: set the facility, facility may"
    echo "      be 'bii' or 'mls'"
    echo "  --dry-run : just show how rsync-dist-info.py would be called"
}

function print_long_help {
    print_short_help
    echo 
    echo "the following options are known to rsync-dist-info.py and can "
    echo "also be used here:"
    echo
    rsync-dist-info.py -h
}

# declare all known insertion devices in a hash:

IDs='U125/2:3\n
U125-2:3\n
U125ID2R:3\n
UE56/2:5\n
UE56-2:5\n
UE56ID3R:5\n
U49/1:7\n
U49-1:7\n
U49ID4R:7\n
UE49:8\n
UE49IT4R:8\n
UE52:9\n
UE52ID5R:9\n
UE46:10\n
UE46IT5R:10\n
UE48:10\n
UE48IT6R:10\n
UE56/1:11\n
UE56-1:11\n
UE56ID6R:11\n
U139:110\n
U139ID6R:110\n
U41:6\n
U41IT6R:6\n
UE112:13\n
UE112ID7R:13\n
U49/2:15\n
U49-2:15\n
U49ID8R:15\n
U125/1:90\n
U125-1:90\n
U125IL2RP:90\n
'

function list_ids {
    tags=`echo "$IDs" | sed -e 's/\([^:]\+\):\([^:]\+\):\([^:]\+\)/\\t\1\\t: \2/g'`
    echo -e "$tags" | expand -t 10
    exit 0
}

realargs="$@"
while [ $# -gt 0 ]; do
    case "$1" in
      -h)
        print_short_help
        exit 0
        ;;
      -H)
        print_long_help
        exit 0
        ;;
      --id-list)
        list_ids
        exit 0
        ;;
      --id)
        no=`echo -e "$IDs" | egrep "^$2:"`
        no=`echo $no | sed -e 's/^[^:]\+://g'`
        if [[ -z "$no" ]]; then
            echo "unknown ID:$2"
            exit 1
        fi
        opts="$opts --filter-names idcp$no"
        shift
        ;;
      --idcp)
        opts="$opts --filter-names idcp$2"
        shift
        ;;
      --ids)
        ids_par_given="yes"
        opts="$opts --filter-names-rx $installed_ids"
        ;;
      -n| --names| -v| --versions| -l| --lifetimes| --idle| --boot-times| --version-info)
        saveme="$saveme $1"
        cmd_given="yes"
        ;;
      --last)
        saveme="$saveme $1 $2"
        shift
        last_given="yes"
        ;;
      --facility)
        facility="no"
        if [ "$2" = "bii" ]; then
            facility="$2"
        fi
        if [ "$2" = "mls" ]; then
            facility="$2"
            CONFIGFILE=$CONFIGFILE_MLS
            installed_ids=$installed_ids_mls
        fi
        if [ "$facility" = "no" ]; then
            echo "unknown faciliy: $2"
            exit 1
        fi
        ;;
      --dry-run)
        dryrun="yes"
        ;;
      *)
        saveme="$saveme $1"
        #break 2
        ;;
    esac
    shift
done

if [[ -n "$ids_par_given" ]]; then
    opts="$opts --filter-names-rx $installed_ids"
fi

opts="$opts -c $CONFIGFILE"

if [[ -z "$cmd_given" ]]; then
    opts="$opts -n"
fi
if [[ -z "$last_given" ]]; then
    opts="$opts --last 10"
fi

opts="$opts $saveme"

#set -- $realargs

#echo saved word: $saveme
#echo run real command: "$@"
#echo "opts: $opts"
if [[ -z "$dryrun" ]]; then
    rsync-dist-info.py $opts
else
    echo "rsync-dist-info.py $opts"
fi

