#!/bin/sh
# -*- shell-script -*-

#  This software is copyrighted by the BERLINER SPEICHERRING
#  GESELLSCHAFT FUER SYNCHROTRONSTRAHLUNG M.B.H., BERLIN, GERMANY.
#  The following terms apply to all files associated with the software.
#  
#  BESSY hereby grants permission to use, copy and modify this
#  software and its documentation for non-commercial, educational or
#  research purposes provided that existing copyright notices are
#  retained in all copies.
#  
#  The receiver of the software provides BESSY with all enhancements, 
#  including complete translations, made by the receiver.
#  
#  IN NO EVENT SHALL BESSY BE LIABLE TO ANY PARTY FOR DIRECT, INDIRECT,
#  SPECIAL, INCIDENTAL OR CONSEQUENTIAL DAMAGES ARISING OUT OF THE USE
#  OF THIS SOFTWARE, ITS DOCUMENTATION OR ANY DERIVATIVES THEREOF, EVEN 
#  IF BESSY HAS BEEN ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
#  
#  BESSY SPECIFICALLY DISCLAIMS ANY WARRANTIES, INCLUDING, BUT NOT LIMITED
#  TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR
#  PURPOSE, AND NON-INFRINGEMENT. THIS SOFTWARE IS PROVIDED ON AN "AS IS"
#  BASIS, AND BESSY HAS NO OBLIGATION TO PROVIDE MAINTENANCE, SUPPORT,
#  UPDATES, ENHANCEMENTS OR MODIFICATIONS.


# 
# Opens the X-Display and starts launch on ash as user acc
# 
# Usage:
#         accLaunch [-t] [-c]
#
#         -t : Tunnel X   --- Use ssh X11 forwarding rather than
#                             direct X connection (useless, since tunneling
#                             is always used...)
#         -c : Compress   --- Use compression in ssh connection
#         -m : withMapper --- provide mapper (needed for orbit display)

# Tested on:   HPUX   (ssh version 1)
#              Linux  (openssh version 2)

# Weitere Environment-Variablen-Settings können in die "" der
# Launch-Start-Zeilen eingefügt werden (mit Leerzeichen getrennt direkt
# vor das launch-Kommando)

hostName=${HOST:-$HOSTNAME}
#echo "hostName=$hostName"
compress=""
tunnelX11="1"
withMapper=""

for cmdArg
do
  [ "$cmdArg" = "-t" ] && tunnelX11="1"
  [ "$cmdArg" = "-c" ] && compress="-C"
  [ "$cmdArg" = "-m" ] && withMapper="+opi +int -browser +mapper"
done

#
# ssh-agent starten und identity laden
# ------------------------------------

# Wenn der ssh-agent nicht läuft, starten
if [ "$SSH_AUTH_SOCK" = "" ]
then
  eval `ssh-agent`
  agentStartedHere=1
fi

# Kein Key geladen? -> ssh-add
[ "$(ssh-add -l | grep 'no ident')" = "" ] || ssh-add </dev/null

#
# Vebindung herstellen
# --------------------

  # Durch ssh getunnelte X-Verbindung
  # Launch starten
  #ssh $compress acc@ash.acc.bessy.de "launch"
  ssh -f -n $compress -Y ctl@ctl-srv.acc.bessy.de "launch $@ $withMapper"

#
# Evtl. ssh-agent wieder abwerfen
# -------------------------------

[ "$agentStartedHere" = "" ] || eval `ssh-agent -k`

exit 0
