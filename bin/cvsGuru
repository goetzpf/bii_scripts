#!/bin/sh

#  This software is copyrighted by the
#  Helmholtz-Zentrum Berlin fuer Materialien und Energie GmbH (HZB),
#  Berlin, Germany.
#  The following terms apply to all files associated with the software.
#  
#  HZB hereby grants permission to use, copy and modify this
#  software and its documentation for non-commercial, educational or
#  research purposes provided that existing copyright notices are
#  retained in all copies.
#  
#  The receiver of the software provides HZB with all enhancements, 
#  including complete translations, made by the receiver.
#  
#  IN NO EVENT SHALL HZB BE LIABLE TO ANY PARTY FOR DIRECT, INDIRECT,
#  SPECIAL, INCIDENTAL OR CONSEQUENTIAL DAMAGES ARISING OUT OF THE USE
#  OF THIS SOFTWARE, ITS DOCUMENTATION OR ANY DERIVATIVES THEREOF, EVEN 
#  IF HZB HAS BEEN ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
#  
#  HZB SPECIFICALLY DISCLAIMS ANY WARRANTIES, INCLUDING, BUT NOT LIMITED
#  TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR
#  PURPOSE, AND NON-INFRINGEMENT. THIS SOFTWARE IS PROVIDED ON AN "AS IS"
#  BASIS, AND HZB HAS NO OBLIGATION TO PROVIDE MAINTENANCE, SUPPORT,
#  UPDATES, ENHANCEMENTS OR MODIFICATIONS.


#
# CVS wrapper script - for ctlguru only!
#
# If cvs is called with update or checkout command,
# the guru lock has to be set first.
#
# Otherwise or after obtaining the lock the original cvs is called.
#

#
# Configuration
#
restricted_users='ctlguru'
CVS=/opt/cvs/bin/cvs

# Setting some useful values


if [ "${DEBUG:+1}" = "1" ]; then
    echo cvs script: DEBUG MODE
fi

# Ignore "-n" calls
if [ "X$1" != "X-n" ]; then

# Check for update or checkout calls
    echo '' $* '' | grep -q " up\(date\)\{0,1\} "
    r1=$?
    echo '' $* '' | grep -q " co "
    r2=$?
    echo '' $* '' | grep -q " checkout "
    r3=$?

    if [ $r1 = 0 -o $r2 = 0 -o $r3 = 0 ]; then

	lockGuru
	if [ $? = 0 ]; then
	    echo guru LOCK set
	    exec $CVS $@
	else
	    exit 1
	fi
    fi
fi

exec $CVS $@
