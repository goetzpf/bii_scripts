#!/bin/sh
#
# Sets file permissions in an EPICS / CapFast / CVS directory tree
#
# Completely cron-job-aware, runs even with "PATH=/usr/bin"
#
# Time-stamp: <24 Jan 06 14:35:59 Ralph Lange>
# $Id: SetPerms,v 1.14 2007-10-18 08:46:24 franksen Exp $
#
PROG=`basename $0`

USAGE="usage: $PROG [directory ...]"

USER=`whoami`

if [ "$1" = "-f" ]
then
  forceOldStyle=true
  shift
else
  forceOldStyle=false
fi

if [ $# = 0 ]; then
    dirs=`pwd`
else
    for f
    do
	if [ ! -d $f ]; then
	    echo $f is not a directory.
	    echo $USAGE
	    exit 1
	else
	    case $f in                   # Prefix relative paths with `pwd`
	    /*) ;;
	    *) f=`pwd`/$f ;;
	    esac
	    dirs="$dirs $f"
	fi
    done
fi

for f in $dirs
do
    case $f in
    *CVS*)
        echo "# NOTE!!! ####################################################################"
	echo "# We're trying to get around \"SetPerms\" for the CVS-repository completely"
	echo "# by using the \"set-group-id\" mode-bit of directories."
	echo "# Please perform the following commands to set up everything."
	echo "#"
	echo "#\tcd $f"
	echo "#\tfind . -type d -user \`whoami\` | xargs chmod g+s"
	echo "#"
	echo "# You don't need to do a \"SetPerms\" in this directory"
	echo "# ($f) anymore!"
	echo "#"
	echo "# And please report any problems to T. Birke or B. Franksen."
	echo "##############################################################################"
	echo
	;;
    *)
	;;
    esac

    case $f in

###############################################################################

    *CVS/epics* | *CVS/support* | *CVS/ioc* | *CVS/IOC* | *CVS/OPI* | *CVS/RulesFiles* )

# Set everything to group epics and ???r-X---

	echo EPICS related repository: $f
	echo Setting everything to group epics and mode ???r-X--- ...
		       
	chgrp -R epics $f > /dev/null 2>&1
	chmod -R g-w,g+rX,o= $f > /dev/null 2>&1

# Set all directories to mode rwxrwsr-x

	echo Setting all directories to mode rwxrwsr-x ...

	find $f/ -type d -follow -user $USER | xargs chmod u=rwx,g=srwx,o=rx 2>/dev/null

# Set all fileattr g+w

	find $f/ -follow -user $USER -name fileattr | xargs chmod g+w 2>/dev/null
    
	;;

###############################################################################

    *CVS/mCAN*)

# Set everything to group interf and ???r-X---

	echo MultiCAN repository: $f
	echo Setting everything to group interf and mode ???r-X--- ...

	chgrp -R interf $f > /dev/null 2>&1
	chmod -R g=rX,o= $f > /dev/null 2>&1

# Set all directories to mode rwxrwxr-x

	echo Setting all directories to mode rwxrwxr-x ...

	find $f/ -type d -follow -user $USER | xargs chmod u=rwx,g=srwx,o=rx  2>/dev/null

# Set all fileattr g+w

	find $f/ -follow -user $USER -name fileattr | xargs chmod g+w 2>/dev/null

	;;

###############################################################################

    *CVS/medmPanels/*)

# Set everything to group swdevel and ???r-X---

	echo medmPanels repository: $f
	echo Setting everything to group swdevel and mode ???r-X--- ...

	chgrp -R swdevel $f > /dev/null 2>&1
	chmod -R g=rX,o= $f > /dev/null 2>&1

# Set all directories to mode rwxrwxr-x

	echo Setting all directories to mode rwxrwxr-x ...

	find $f/ -type d -follow -user $USER | xargs chmod u=rwx,g=srwx,o=rx  2>/dev/null

# Set all fileattr g+w

	find $f/ -follow -user $USER -name fileattr | xargs chmod g+w 2>/dev/null

	;;

###############################################################################

    */csr/capfast* | */epics/*/support/capfast*)

# Set everything to group epics and ???r-Xr-X

	echo CapFast tree: $f
	echo Setting everything to group epics and mode ???r-Xr-X ...
		       
	chgrp -R epics $f > /dev/null 2>&1
	chmod -R go=rX $f > /dev/null 2>&1
		       
# Set all directories and executables to group epima and mode rwxrwxr-x

	echo Setting all directories and executables to group epima and mode rwxrwxr-x ...

	files=`find $f/ -follow -user $USER -a \( -type d -o -type f -perm +111 \)`
	if [ -n "$files" ]; then
	    echo $files | xargs chmod u=rwx,g=rwx,o=rx
	    echo $files | xargs chgrp epima
	fi
       
# Make binary executables unreadable for others

	echo Making binary executables unreadable for others...
		       
	find $f/ -type f -perm +111 -follow -user $USER \
	 -exec /bin/sh -c "chmod g-w {}; file {} | grep -v script | grep -q executable && chmod o-r {}" \;

	;;
  
###############################################################################

  */epics/templates*)

# Set everything to group epics and ???r-Xr-X

	echo EPICS templates tree: $f
	echo Setting everything to group epics and mode ???r-Xr-X ...
		       
	chgrp -R epics $f > /dev/null 2>&1
	chmod -R g=rX,o=rX $f > /dev/null 2>&1
		       
# Set all directories and executables to group epima and mode rwxrwxr-x

	echo Setting all directories and executables to group epima and mode rwxrwxr-x ...
		       
	files=`find $f/ -follow -user $USER -a \( -type d -o -type f -perm +111 \)`
	if [ -n "$files" ]; then
	    echo $files | xargs chmod u=rwx,g=rwx,o=rx
	    echo $files | xargs chgrp epima
	fi
	;;
  
###############################################################################

    */Epics/*/support*)

# Set everything to group epics-support and ???r-X---

	echo Epics support tree: $f
	echo Setting everything to group epics-support and mode ???r-Xr-X ...

	chgrp -R epics-support $f > /dev/null 2>&1
	chmod -R go=rX $f > /dev/null 2>&1
		       
# Set all directories and executables to mode rwxrwxr-x

	echo Setting all directories and executables to mode rwxrwxr-x ...

	files=`find $f/ -follow -user $USER -a \( -type d -o -type f -perm +111 \)`
	if [ -n "$files" ]; then
	    echo $files | xargs chmod ug=rwx,o=rx
	fi
        find -type d -user $USER -exec chmod g+s {} \;

	;;

###############################################################################

    */vw/* | */epics/*/support* | */epics/base* | */epics/*/base* | */epics/extensions* |\
    */vxworks/* | */Epics/base* | */Epics/*/base* | */Epics/extensions* )

# Set everything to group epics and ???r-X---

	echo EPICS/vxWorks  tree: $f
	echo Setting everything to group epics and mode ???r-Xr-X ...
		       
	chgrp -R epics $f > /dev/null 2>&1
	chmod -R go=rX $f > /dev/null 2>&1
		       
# Set all directories and executables to group epima and mode rwxrwxr-x

	echo Setting all directories and executables to group epima and mode rwxrwxr-x ...

	files=`find $f/ -follow -user $USER -a \( -type d -o -type f -perm +111 \)`
	if [ -n "$files" ]; then
	    echo $files | xargs chmod ug=rwx,o=rx
	    echo $files | xargs chgrp epima
	fi
        find -type d -user $USER -exec chmod g+s {} \;

	;;
  
###############################################################################

  */epics/config*)
	   
	echo Setting everything to group epics and mode ???r-X--- ...
			
	chgrp epics $f > /dev/null 2>&1
	chmod g=rX,o= $f > /dev/null 2>&1

	;;

###############################################################################

    */htdocs*)

# Set everything to group wwwadm and ???r-Xr-X

	echo Web tree: $f
	echo Setting everything to group wwwadm and mode ???r-Xr-X ...
		       
	chgrp -R wwwadm $f > /dev/null 2>&1
	chmod -R go=rX $f > /dev/null 2>&1

# Set all directories to mode rwxrwxr-x

	echo Setting all directories to mode rwxrwxr-x ...

	find $f/ -type d -follow -user $USER | xargs chmod u=rwx,g=srwx,o=rx 2>/dev/null

	;;

###############################################################################

    *CVS/bii_scripts*)

# Set everything to group interf and ???r-X---

	echo bii_scripts related repository: $f
	echo Setting everything to group scrptdev and mode ???r-X--- ...

	chgrp -R scrptdev $f > /dev/null 2>&1
	chmod -R g=rX,o= $f > /dev/null 2>&1

# Set all directories to mode rwxrwxr-x

	echo Setting all directories to mode rwxrwxr-x ...

	find $f/ -type d -follow -user $USER | xargs chmod u=rwx,g=srwx,o=rx 2>/dev/null

# Set all fileattr g+w

	find $f/ -follow -user $USER -name fileattr | xargs chmod g+w 2>/dev/null

	;;

###############################################################################

    /opt/csr)

	echo Setting everything to mode a+r ...

        for d in bin lib man share
	do
            find $f/$d -follow -user $USER -exec chmod a+r {} \;
        done

	;;
  
###############################################################################

  *)
	echo Not in EPICS or CapFast or Web Tree.
	exit 1
	;;
    esac
done

exit 0
